<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Visualizaﾃｧﾃ｣o - Denﾃｺncias Pﾃｺblicas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; 
        }
        .header-panel {
            background-color: #3b82f6; 
            color: white;
        }
        .card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .data-value {
            font-size: 2.5rem; 
            font-weight: 800;
        }
        /* 圷 ALERTA VISUAL: ANIMAﾃﾃグ DE PISCAR 圷 */
        @keyframes blink {
            0%, 49% { background-color: #ffcccc; } /* Vermelho claro */
            50%, 100% { background-color: transparent; }
        }
        .blinking-row {
            animation: blink 0.5s step-end infinite;
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="header-panel p-4 shadow-lg sticky top-0 z-10">
        <h1 class="text-2xl font-bold">Painel de Visualizaﾃｧﾃ｣o - Denﾃｺncias Pﾃｺblicas</h1>
    </header>

    <main class="p-6">
        <h2 class="text-3xl font-semibold text-gray-800 mb-6">Mapeamento de Ocorrﾃｪncias</h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            
            <div class="card p-5">
                <p class="text-gray-500 font-semibold mb-2">Total de Denﾃｺncias</p>
                <div id="totalDenuncias" class="data-value text-blue-600">0</div>
            </div>

            <div class="card p-5">
                <p class="text-gray-500 font-semibold mb-2">Mﾃｩdia de Idade da Vﾃｭtima</p>
                <div id="mediaIdade" class="data-value text-green-600">0</div>
            </div>

            <div class="card p-5">
                <p class="text-gray-500 font-semibold mb-2">Denﾃｺncias Anﾃｴnimas (%)</p>
                <div id="percentualAnonimas" class="data-value text-red-600">0%</div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <input type="text" id="filterEstado" placeholder="Filtrar por Estado (Ex: SP)" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <input type="text" id="filterMunicipio" placeholder="Filtrar por Municﾃｭpio" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <input type="text" id="filterBairro" placeholder="Filtrar por Bairro" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div class="card p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Ocorrﾃｪncias Encontradas</h3>
            <div id="ocorrenciasList" class="space-y-4">
                <p class="text-center text-gray-500">Carregando dados em tempo real...</p>
            </div>
        </div>

    </main>

    <div id="detailsModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h2 class="text-2xl font-bold text-blue-600">Detalhes Completos da Denﾃｺncia</h2>
                    <button id="closeDetailsModal" class="text-gray-500 hover:text-gray-800 text-3xl font-light leading-none">&times;</button>
                </div>

                <div class="space-y-4 text-gray-700">
                    <div class="grid grid-cols-2 gap-4 border-b pb-3">
                        <div>
                            <p class="text-sm font-semibold text-gray-500">ID da Denﾃｺncia</p>
                            <p id="detailId" class="text-base font-mono break-all"></p>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-500">Data e Hora</p>
                            <p id="detailDate" class="text-base"></p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm font-semibold text-gray-500">Nome do Denunciante</p>
                            <p id="detailName" class="text-base font-medium"></p>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-500">Denﾃｺncia Anﾃｴnima</p>
                            <p id="detailAnonimo" class="text-base font-medium"></p>
                        </div>
                    </div>

                    <div class="p-3 bg-blue-50 rounded-lg">
                        <p class="text-sm font-semibold text-gray-500">Localizaﾃｧﾃ｣o</p>
                        <p id="detailLocation" class="text-base"></p>
                    </div>

                    <div class="p-3 bg-blue-50 rounded-lg">
                        <p class="text-sm font-semibold text-gray-500">Coordenadas (GPS)</p>
                        <p id="detailCoords" class="text-base"></p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 border-b pb-3">
                        <div>
                            <p class="text-sm font-semibold text-gray-500">Sexo da Vﾃｭtima</p>
                            <p id="detailVictimSex" class="text-base"></p>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-500">Idade da Vﾃｭtima</p>
                            <p id="detailVictimAge" class="text-base"></p>
                        </div>
                    </div>

                    <div>
                        <p class="text-sm font-semibold text-gray-500">Descriﾃｧﾃ｣o Detalhada</p>
                        <p id="detailDescription" class="text-base whitespace-pre-wrap p-3 bg-gray-100 rounded-md border"></p>
                    </div>
                </div>

                <div class="p-4 bg-gray-100 rounded-lg space-y-4 border-t mt-4">
                    <h3 class="text-lg font-bold text-gray-800">Aﾃｧﾃｵes Administrativas</h3>
                    
                    <div>
                        <label for="adminStatus" class="block text-sm font-semibold text-gray-500 mb-1">Status de Tratamento</label>
                        <select id="adminStatus" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800">
                            </select>
                    </div>

                    <div>
                        <label for="adminNotes" class="block text-sm font-semibold text-gray-500 mb-1">Notas do Administrador/Encaminhamento</label>
                        <textarea id="adminNotes" rows="4" placeholder="Registre o histﾃｳrico de anﾃ｡lise e o ﾃｳrgﾃ｣o para o qual foi encaminhada." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800"></textarea>
                    </div>
                    
                    <button id="saveAdminActionBtn" class="w-full px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors">
                        Salvar Aﾃｧﾃ｣o
                    </button>
                </div>
            </div>
            
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button id="closeDetailsModalBottom" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">Fechar</button>
            </div>
        </div>
    </div>
    <audio id="newReportAudio" src="alerta.mp3" preload="auto"></audio>

    <script type="module">
        // 圷 NOVO IMPORT: doc e updateDoc para salvar o status 圷
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, where, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURAﾃﾃグ (DEVE SER A MESMA USADA NO APP DE DENﾃ哢CIA) ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyA8mUIkIGk-i2RvlrD-_TbLlZJAnOSwgtw", // Substitua pela sua chave
            authDomain: "sos-app-287a3.firebaseapp.com",
            projectId: "sos-app-287a3",
            storageBucket: "sos-app-287a3.firebasestorage.app",
            messagingSenderId: "365524443228",
            appId: "1:365524443228:web:ad9bf99c80ecaa81d58699",
            measurementId: "G-VTGJGE5SPQ"
        };

        const APP_ID = 'default-app-id'; 
        const ADMIN_TOKEN = null; 

        // 圷 NOVO: Opﾃｧﾃｵes de Status 圷
        const STATUS_OPTIONS = [
            "Pendente",
            "Em Anﾃ｡lise",
            "Encaminhada",
            "Concluﾃｭda/Arquivada"
        ];
        
        // --- 2. REFERﾃ劾CIAS DOM ---
        const totalDenunciasDiv = document.getElementById('totalDenuncias');
        const mediaIdadeDiv = document.getElementById('mediaIdade');
        const percentualAnonimasDiv = document.getElementById('percentualAnonimas');
        const ocorrenciasListDiv = document.getElementById('ocorrenciasList');
        const filterEstado = document.getElementById('filterEstado');
        const filterMunicipio = document.getElementById('filterMunicipio');
        const filterBairro = document.getElementById('filterBairro');
        const detailsModal = document.getElementById('detailsModal');
        const closeDetailsModal = document.getElementById('closeDetailsModal');
        const closeDetailsModalBottom = document.getElementById('closeDetailsModalBottom');
        const newReportAudio = document.getElementById('newReportAudio');
        
        // 圷 NOVO: Referﾃｪncias para Aﾃｧﾃｵes Administrativas 圷
        const adminStatusSelect = document.getElementById('adminStatus');
        const adminNotesTextarea = document.getElementById('adminNotes');
        const saveAdminActionBtn = document.getElementById('saveAdminActionBtn');


        // --- 3. VARIﾃ〃EIS DE ESTADO ---
        let db;
        let auth;
        let unsubscribe = null; 
        let allReportsData = []; 
        let firstLoad = true; 


        // --- 4. FUNﾃﾃグ DE INICIALIZAﾃﾃグ ---
        async function initDashboard() {
            try {
                const app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Preenche o seletor de status (sﾃｳ precisa ser feito uma vez)
                adminStatusSelect.innerHTML = STATUS_OPTIONS.map(status => 
                    `<option value="${status}">${status}</option>`
                ).join('');

                if (ADMIN_TOKEN) {
                    await signInWithCustomToken(auth, ADMIN_TOKEN);
                    startRealtimeListener();
                } else {
                    startRealtimeListener(); 
                }
                
            } catch (error) {
                console.error("Erro na inicializaﾃｧﾃ｣o ou autenticaﾃｧﾃ｣o do Firebase:", error);
                ocorrenciasListDiv.innerHTML = `<p class="text-red-600 text-center font-bold">ERRO CRﾃ控ICO: Nﾃ｣o foi possﾃｭvel conectar ao banco de dados. Verifique a configuraﾃｧﾃ｣o e a autenticaﾃｧﾃ｣o.</p>`;
            }
        }

        // --- 5. FUNﾃﾃグ DE OBTENﾃﾃグ DE DADOS (LISTENER EM TEMPO REAL) ---

        function getPublicReportsCollectionRef() {
            const path = `/artifacts/${APP_ID}/denuncias_publicas`;
            return collection(db, path);
        }

        function playNewReportSound() {
            if (newReportAudio) {
                newReportAudio.load();
                newReportAudio.play().catch(error => {
                    console.warn("Falha ao tocar o ﾃ｡udio:", error);
                });
            }
        }


        function startRealtimeListener() {
            if (unsubscribe) {
                unsubscribe(); 
            }

            const reportsRef = getPublicReportsCollectionRef();
            // 圷 NOVO: Garante que "status" exista para ordenar.
            let q = query(reportsRef, orderBy("timestamp", "desc")); 

            const estado = filterEstado.value.trim().toUpperCase();
            const municipio = filterMunicipio.value.trim();
            // ... (Filtros de estado/municﾃｭpio)

            if (estado) {
                q = query(q, where("estado", "==", estado));
            }
            if (municipio) {
                q = query(q, where("municipio", "==", municipio));
            }

            unsubscribe = onSnapshot(q, (snapshot) => {
                const currentReports = [];
                let totalIdades = 0;
                let anonimasCount = 0;
                let newReportIds = new Set(); 

                // Detecﾃｧﾃ｣o de Novas Denﾃｺncias
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" && !firstLoad) {
                        newReportIds.add(change.doc.id);
                    }
                });


                // Processamento de dados
                snapshot.forEach((doc) => {
                    const data = { 
                        id: doc.id, 
                        // 圷 Adiciona status default caso nﾃ｣o exista 圷
                        status: STATUS_OPTIONS[0],
                        adminNotes: '',
                        ...doc.data() 
                    };
                    currentReports.push(data);

                    totalIdades += data.idade || 0;
                    if (data.anonimo) {
                        anonimasCount++;
                    }
                });
                
                allReportsData = currentReports; 

                // Atualiza Cards
                const total = allReportsData.length;
                totalDenunciasDiv.textContent = total.toLocaleString('pt-BR');
                const mediaIdade = total > 0 ? (totalIdades / total).toFixed(1) : '0';
                mediaIdadeDiv.textContent = mediaIdade;
                const percentualAnonimas = total > 0 ? ((anonimasCount / total) * 100).toFixed(0) : '0';
                percentualAnonimasDiv.textContent = `${percentualAnonimas}%`;

                // Renderiza Lista
                renderOcorrenciasList(allReportsData, newReportIds);
                
                if (newReportIds.size > 0) {
                    playNewReportSound();
                }

                firstLoad = false;


            }, (error) => {
                console.error("Erro ao carregar denﾃｺncias:", error);
                ocorrenciasListDiv.innerHTML = `<p class="text-red-600 text-center">ERRO DE ACESSO: Verifique as Regras de Seguranﾃｧa do Firestore.</p>`;
            });
        }

        // --- 6. FUNﾃﾃグ DE RENDERIZAﾃﾃグ DA LISTA ---

        function renderOcorrenciasList(reports, newReportIds = new Set()) {
            if (reports.length === 0) {
                ocorrenciasListDiv.innerHTML = `<p class="text-center text-gray-500 mt-8">Nenhuma ocorrﾃｪncia encontrada com os filtros atuais.</p>`;
                return;
            }

            let htmlContent = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Local (M/E)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vﾃｭtima (I/S)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aﾃｧﾃ｣o</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;

            reports.forEach((data) => {
                let dateStr = 'N/A';
                try {
                    dateStr = new Date(data.timestamp).toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                } catch (e) {
                    dateStr = data.timestamp;
                }

                // Determina a cor do status de tratamento
                let statusBadge = '';
                let statusColorClass = 'bg-gray-100 text-gray-800'; // Default
                const status = data.status || STATUS_OPTIONS[0]; // Pega o status ou usa Pendente

                if (status === 'Pendente') statusColorClass = 'bg-red-100 text-red-800';
                else if (status === 'Em Anﾃ｡lise') statusColorClass = 'bg-yellow-100 text-yellow-800';
                else if (status === 'Encaminhada') statusColorClass = 'bg-blue-100 text-blue-800';
                else if (status === 'Concluﾃｭda/Arquivada') statusColorClass = 'bg-green-100 text-green-800';

                statusBadge = `
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColorClass}">
                        ${status}
                    </span>
                `;
                
                const isNew = newReportIds.has(data.id);
                const rowClasses = isNew ? 'blinking-row' : '';

                htmlContent += `
                    <tr id="report-row-${data.id}" class="${rowClasses}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${dateStr}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.municipio} - ${data.estado}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.idade} anos, ${data.sexo}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            <button onclick="viewDetails('${data.id}')" class="text-blue-600 hover:text-blue-900 font-medium">Ver Detalhes</button>
                        </td>
                    </tr>
                `;
                
                if (isNew) {
                    setTimeout(() => {
                        const row = document.getElementById(`report-row-${data.id}`);
                        if (row) {
                            row.classList.remove('blinking-row');
                        }
                    }, 15000); 
                }
            });

            htmlContent += `
                        </tbody>
                    </table>
                </div>
            `;
            ocorrenciasListDiv.innerHTML = htmlContent;
        }
        
        // --- 7. IMPLEMENTAﾃﾃグ DA MODAL DE DETALHES E Aﾃﾃグ ---

        window.viewDetails = (reportId) => {
            const report = allReportsData.find(r => r.id === reportId);
            
            if (!report) {
                alert("Erro: Denﾃｺncia nﾃ｣o encontrada na lista atual.");
                return;
            }

            // 圷 NOVO: Armazena o ID no elemento da modal para a funﾃｧﾃ｣o de salvar 圷
            detailsModal.dataset.reportId = report.id; 

            let dateStr = 'N/A';
            try {
                dateStr = new Date(report.timestamp).toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
            } catch (e) {
                dateStr = report.timestamp;
            }

            // Preenchimento dos dados do denunciante (inﾃｭcio da modal)
            document.getElementById('detailId').textContent = report.id;
            document.getElementById('detailDate').textContent = dateStr;
            document.getElementById('detailName').textContent = report.nomeDenunciante;
            document.getElementById('detailAnonimo').textContent = report.anonimo ? 'Sim' : 'Nﾃ｣o';
            document.getElementById('detailLocation').textContent = `${report.bairro}, ${report.municipio} - ${report.estado}`;
            document.getElementById('detailCoords').textContent = `Lat: ${report.latitude} / Lon: ${report.longitude}`;
            document.getElementById('detailVictimSex').textContent = report.sexo;
            document.getElementById('detailVictimAge').textContent = `${report.idade} anos`;
            document.getElementById('detailDescription').textContent = report.descricao;
            
            // 圷 NOVO: Preenchimento dos campos administrativos 圷
            // Define o status atual (ou Pendente como default)
            adminStatusSelect.value = report.status || STATUS_OPTIONS[0]; 
            // Preenche as notas do admin (se existirem)
            adminNotesTextarea.value = report.adminNotes || '';
            
            detailsModal.classList.remove('hidden');
        };
        
        // 圷 NOVO: FUNﾃﾃグ PARA SALVAR O STATUS E AS NOTAS 圷
        async function saveAdminAction() {
            const reportId = detailsModal.dataset.reportId;
            if (!reportId) {
                alert("Erro: ID da denﾃｺncia nﾃ｣o encontrado para salvar.");
                return;
            }

            const newStatus = adminStatusSelect.value;
            const newNotes = adminNotesTextarea.value;
            
            const reportsCollectionRef = getPublicReportsCollectionRef();
            const docRef = doc(reportsCollectionRef, reportId);

            // Confirmaﾃｧﾃ｣o antes de salvar
            if (!confirm(`Confirmar a atualizaﾃｧﾃ｣o do status para "${newStatus}"?`)) {
                return;
            }

            try {
                await updateDoc(docRef, {
                    status: newStatus,
                    adminNotes: newNotes,
                    // Adiciona um timestamp para rastrear a ﾃｺltima modificaﾃｧﾃ｣o do admin
                    lastAdminUpdate: Date.now() 
                });

                alert("Status e notas salvas com sucesso!");
                detailsModal.classList.add('hidden'); 

            } catch (error) {
                console.error("Erro ao salvar aﾃｧﾃｵes do administrador:", error);
                alert("Erro ao salvar: Verifique suas Regras de Seguranﾃｧa e conexﾃ｣o.");
            }
        }


        // --- 8. LISTENERS GERAIS ---

        document.addEventListener('DOMContentLoaded', () => {
            initDashboard();

            filterEstado.addEventListener('change', startRealtimeListener);
            filterMunicipio.addEventListener('change', startRealtimeListener);
            filterBairro.addEventListener('change', startRealtimeListener);

            // Listeners da Modal
            const closeModal = () => detailsModal.classList.add('hidden');
            closeDetailsModal.addEventListener('click', closeModal);
            closeDetailsModalBottom.addEventListener('click', closeModal);
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !detailsModal.classList.contains('hidden')) {
                    closeModal();
                }
            });
            
            // 圷 NOVO: Listener para o botﾃ｣o Salvar Aﾃｧﾃ｣o 圷
            saveAdminActionBtn.addEventListener('click', saveAdminAction);
        });

    </script>

</body>
</html>