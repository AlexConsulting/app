<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Visualiza√ß√£o - Den√∫ncias P√∫blicas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Fundo claro para dashboard */
        }
        .header-panel {
            background-color: #3b82f6; /* Azul prim√°rio */
            color: white;
        }
        .card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .data-value {
            font-size: 2.5rem; /* Aumenta o tamanho dos n√∫meros */
            font-weight: 800;
        }
        /* üö® NOVO: ANIMA√á√ÉO DE PISCAR PARA ALERTAS üö® */
        @keyframes blink {
            0%, 49% { background-color: #ffcccc; } /* Vermelho claro */
            50%, 100% { background-color: transparent; }
        }
        .blinking-row {
            /* Aplica a anima√ß√£o, dura 0.5s, step-end para transi√ß√£o imediata, infinito */
            animation: blink 0.5s step-end infinite;
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="header-panel p-4 shadow-lg sticky top-0 z-10">
        <h1 class="text-2xl font-bold">Painel de Visualiza√ß√£o - Den√∫ncias P√∫blicas</h1>
    </header>

    <main class="p-6">
        <h2 class="text-3xl font-semibold text-gray-800 mb-6">Mapeamento de Ocorr√™ncias</h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            
            <div class="card p-5">
                <p class="text-gray-500 font-semibold mb-2">Total de Den√∫ncias</p>
                <div id="totalDenuncias" class="data-value text-blue-600">0</div>
            </div>

            <div class="card p-5">
                <p class="text-gray-500 font-semibold mb-2">M√©dia de Idade da V√≠tima</p>
                <div id="mediaIdade" class="data-value text-green-600">0</div>
            </div>

            <div class="card p-5">
                <p class="text-gray-500 font-semibold mb-2">Den√∫ncias An√¥nimas (%)</p>
                <div id="percentualAnonimas" class="data-value text-red-600">0%</div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <input type="text" id="filterEstado" placeholder="Filtrar por Estado (Ex: SP)" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <input type="text" id="filterMunicipio" placeholder="Filtrar por Munic√≠pio" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <input type="text" id="filterBairro" placeholder="Filtrar por Bairro" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div class="card p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Ocorr√™ncias Encontradas</h3>
            <div id="ocorrenciasList" class="space-y-4">
                <p class="text-center text-gray-500">Carregando dados em tempo real...</p>
            </div>
        </div>

    </main>

    <div id="detailsModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h2 class="text-2xl font-bold text-blue-600">Detalhes Completos da Den√∫ncia</h2>
                    <button id="closeDetailsModal" class="text-gray-500 hover:text-gray-800 text-3xl font-light leading-none">&times;</button>
                </div>

                <div class="space-y-4 text-gray-700">
                    <div class="grid grid-cols-2 gap-4 border-b pb-3">
                        <div>
                            <p class="text-sm font-semibold text-gray-500">ID da Den√∫ncia</p>
                            <p id="detailId" class="text-base font-mono break-all"></p>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-500">Data e Hora</p>
                            <p id="detailDate" class="text-base"></p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm font-semibold text-gray-500">Nome do Denunciante</p>
                            <p id="detailName" class="text-base font-medium"></p>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-500">Den√∫ncia An√¥nima</p>
                            <p id="detailAnonimo" class="text-base font-medium"></p>
                        </div>
                    </div>

                    <div class="p-3 bg-blue-50 rounded-lg">
                        <p class="text-sm font-semibold text-gray-500">Localiza√ß√£o</p>
                        <p id="detailLocation" class="text-base"></p>
                    </div>

                    <div class="p-3 bg-blue-50 rounded-lg">
                        <p class="text-sm font-semibold text-gray-500">Coordenadas (GPS)</p>
                        <p id="detailCoords" class="text-base"></p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 border-b pb-3">
                        <div>
                            <p class="text-sm font-semibold text-gray-500">Sexo da V√≠tima</p>
                            <p id="detailVictimSex" class="text-base"></p>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-500">Idade da V√≠tima</p>
                            <p id="detailVictimAge" class="text-base"></p>
                        </div>
                    </div>

                    <div>
                        <p class="text-sm font-semibold text-gray-500">Descri√ß√£o Detalhada</p>
                        <p id="detailDescription" class="text-base whitespace-pre-wrap p-3 bg-gray-100 rounded-md border"></p>
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button id="closeDetailsModalBottom" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">Fechar</button>
            </div>
        </div>
    </div>
    <audio id="newReportAudio" src="alerta.mp3" preload="auto"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURA√á√ÉO (DEVE SER A MESMA USADA NO APP DE DEN√öNCIA) ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyA8mUIkIGk-i2RvlrD-_TbLlZJAnOSwgtw", // Substitua pela sua chave
            authDomain: "sos-app-287a3.firebaseapp.com",
            projectId: "sos-app-287a3",
            storageBucket: "sos-app-287a3.firebasestorage.app",
            messagingSenderId: "365524443228",
            appId: "1:365524443228:web:ad9bf99c80ecaa81d58699",
            measurementId: "G-VTGJGE5SPQ"
        };

        const APP_ID = 'default-app-id'; // Deve ser o mesmo APP_ID usado no app de den√∫ncia.
        const ADMIN_TOKEN = null; // Token de autentica√ß√£o customizado para administradores/autoridades.

        // --- 2. REFER√äNCIAS DOM ---
        const totalDenunciasDiv = document.getElementById('totalDenuncias');
        const mediaIdadeDiv = document.getElementById('mediaIdade');
        const percentualAnonimasDiv = document.getElementById('percentualAnonimas');
        const ocorrenciasListDiv = document.getElementById('ocorrenciasList');
        const filterEstado = document.getElementById('filterEstado');
        const filterMunicipio = document.getElementById('filterMunicipio');
        const filterBairro = document.getElementById('filterBairro');
        // Refer√™ncias DOM da Modal de Detalhes
        const detailsModal = document.getElementById('detailsModal');
        const closeDetailsModal = document.getElementById('closeDetailsModal');
        const closeDetailsModalBottom = document.getElementById('closeDetailsModalBottom');
        // üö® NOVO: Refer√™ncia DOM do √Åudio üö®
        const newReportAudio = document.getElementById('newReportAudio');


        // --- 3. VARI√ÅVEIS DE ESTADO ---
        let db;
        let auth;
        let unsubscribe = null; 
        let allReportsData = []; // Armazena a lista completa de den√∫ncias
        let firstLoad = true; // Flag para ignorar alertas no primeiro carregamento.


        // --- 4. FUN√á√ÉO DE INICIALIZA√á√ÉO ---
        async function initDashboard() {
            try {
                const app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autentica√ß√£o: Necess√°ria para garantir que APENAS autoridades acessem o painel.
                if (ADMIN_TOKEN) {
                    await signInWithCustomToken(auth, ADMIN_TOKEN);
                    console.log("Autentica√ß√£o de administrador bem-sucedida com Token Customizado.");
                    startRealtimeListener();
                } else {
                    console.warn("Nenhum token customizado fornecido. O listener de dados depende de REGRAS DE SEGURAN√áA que permitam leitura p√∫blica (ou autenticada) da cole√ß√£o.");
                    startRealtimeListener(); 
                }
                
            } catch (error) {
                console.error("Erro na inicializa√ß√£o ou autentica√ß√£o do Firebase:", error);
                ocorrenciasListDiv.innerHTML = `<p class="text-red-600 text-center font-bold">ERRO CR√çTICO: N√£o foi poss√≠vel conectar ao banco de dados. Verifique a configura√ß√£o e a autentica√ß√£o.</p>`;
            }
        }

        // --- 5. FUN√á√ÉO DE OBTEN√á√ÉO DE DADOS (LISTENER EM TEMPO REAL) ---

        function getPublicReportsCollectionRef() {
            // Cole√ß√£o centralizada para visualiza√ß√£o
            const path = `/artifacts/${APP_ID}/denuncias_publicas`;
            return collection(db, path);
        }

        /**
         * üö® NOVO: Tenta tocar o √°udio de alerta. üö®
         * Nota: Navegadores modernos podem bloquear √°udio se n√£o houver intera√ß√£o do usu√°rio.
         */
        function playNewReportSound() {
            if (newReportAudio) {
                newReportAudio.load();
                newReportAudio.play().catch(error => {
                    console.warn("Falha ao tocar o √°udio (pode exigir intera√ß√£o do usu√°rio):", error);
                    // O alerta sonoro pode falhar se o usu√°rio n√£o tiver interagido com a p√°gina
                });
            }
        }


        function startRealtimeListener() {
            if (unsubscribe) {
                unsubscribe(); // Cancela o listener anterior
            }

            const reportsRef = getPublicReportsCollectionRef();
            let q = query(reportsRef, orderBy("timestamp", "desc")); // Ordena pela mais recente

            // Adiciona filtros se os campos n√£o estiverem vazios
            const estado = filterEstado.value.trim().toUpperCase();
            const municipio = filterMunicipio.value.trim();
            const bairro = filterBairro.value.trim();

            if (estado) {
                q = query(q, where("estado", "==", estado));
            }
            if (municipio) {
                q = query(q, where("municipio", "==", municipio));
            }
            // Filtrar por bairro: Adicione o filtro abaixo se tiver um √≠ndice composto no Firestore
            // if (bairro) {
            //     q = query(q, where("bairro", "==", bairro));
            // }

            unsubscribe = onSnapshot(q, (snapshot) => {
                const currentReports = [];
                let totalIdades = 0;
                let anonimasCount = 0;
                // üö® NOVO: Conjunto para armazenar IDs das den√∫ncias rec√©m-adicionadas üö®
                let newReportIds = new Set(); 

                // 1. Detec√ß√£o de Novas Den√∫ncias (DOC CHANGES)
                snapshot.docChanges().forEach((change) => {
                    // Verifica se foi adicionado e se N√ÉO √© o carregamento inicial (primeira vez)
                    if (change.type === "added" && !firstLoad) {
                        newReportIds.add(change.doc.id);
                        console.log("NOVA DEN√öNCIA DETECTADA:", change.doc.id);
                    }
                });


                // 2. Processamento normal dos dados (para estat√≠sticas e lista)
                snapshot.forEach((doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    currentReports.push(data);

                    // C√°lculo de Estat√≠sticas
                    totalIdades += data.idade || 0;
                    if (data.anonimo) {
                        anonimasCount++;
                    }
                });
                
                // Armazena a lista de den√∫ncias completa
                allReportsData = currentReports; 

                // Atualiza Cards de Estat√≠sticas
                const total = allReportsData.length;
                totalDenunciasDiv.textContent = total.toLocaleString('pt-BR');
                
                const mediaIdade = total > 0 ? (totalIdades / total).toFixed(1) : '0';
                mediaIdadeDiv.textContent = mediaIdade;

                const percentualAnonimas = total > 0 ? ((anonimasCount / total) * 100).toFixed(0) : '0';
                percentualAnonimasDiv.textContent = `${percentualAnonimas}%`;

                // 3. Renderiza a Lista/Tabela, passando os novos IDs
                renderOcorrenciasList(allReportsData, newReportIds);
                
                // 4. Se houver novas den√∫ncias, dispara o alerta sonoro
                if (newReportIds.size > 0) {
                    playNewReportSound();
                }

                // 5. Marca o primeiro carregamento como conclu√≠do
                firstLoad = false;


            }, (error) => {
                console.error("Erro ao carregar den√∫ncias:", error);
                ocorrenciasListDiv.innerHTML = `<p class="text-red-600 text-center">ERRO DE ACESSO: Verifique as Regras de Seguran√ßa do Firestore para a cole√ß√£o p√∫blica.</p>`;
            });
        }

        // --- 6. FUN√á√ÉO DE RENDERIZA√á√ÉO DA LISTA ---

        function renderOcorrenciasList(reports, newReportIds = new Set()) {
            if (reports.length === 0) {
                ocorrenciasListDiv.innerHTML = `<p class="text-center text-gray-500 mt-8">Nenhuma ocorr√™ncia encontrada com os filtros atuais.</p>`;
                return;
            }

            let htmlContent = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Local (M/E)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">V√≠tima (I/S)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descri√ß√£o / A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;

            reports.forEach((data) => {
                let dateStr = 'N/A';
                try {
                    dateStr = new Date(data.timestamp).toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                } catch (e) {
                    dateStr = data.timestamp;
                }

                const statusColor = data.anonimo ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800';
                
                // üö® NOVO: Aplica a classe de piscar se o ID estiver no Set üö®
                const isNew = newReportIds.has(data.id);
                const rowClasses = isNew ? 'blinking-row' : '';

                htmlContent += `
                    <tr id="report-row-${data.id}" class="${rowClasses}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${dateStr}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.municipio} - ${data.estado}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.idade} anos, ${data.sexo}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${data.anonimo ? 'AN√îNIMO' : 'COM NOME'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            <button onclick="viewDetails('${data.id}')" class="text-blue-600 hover:text-blue-900 font-medium">Ver Detalhes</button>
                        </td>
                    </tr>
                `;
                
                // üö® NOVO: Agenda a remo√ß√£o da classe de piscar ap√≥s 15 segundos üö®
                if (isNew) {
                    setTimeout(() => {
                        const row = document.getElementById(`report-row-${data.id}`);
                        if (row) {
                            row.classList.remove('blinking-row');
                        }
                    }, 15000); 
                }
            });

            htmlContent += `
                        </tbody>
                    </table>
                </div>
            `;
            ocorrenciasListDiv.innerHTML = htmlContent;
        }
        
        // --- 7. IMPLEMENTA√á√ÉO DA MODAL DE DETALHES (INALTERADA) ---

        window.viewDetails = (reportId) => {
            // Encontra a den√∫ncia correspondente no array armazenado
            const report = allReportsData.find(r => r.id === reportId);
            
            if (!report) {
                alert("Erro: Den√∫ncia n√£o encontrada na lista atual.");
                return;
            }

            // Fun√ß√£o auxiliar para formata√ß√£o de data
            let dateStr = 'N/A';
            try {
                dateStr = new Date(report.timestamp).toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
            } catch (e) {
                dateStr = report.timestamp;
            }

            // Preenche os elementos da modal com os dados do relat√≥rio
            document.getElementById('detailId').textContent = report.id;
            document.getElementById('detailDate').textContent = dateStr;
            document.getElementById('detailName').textContent = report.nomeDenunciante;
            document.getElementById('detailAnonimo').textContent = report.anonimo ? 'Sim' : 'N√£o';
            document.getElementById('detailLocation').textContent = `${report.bairro}, ${report.municipio} - ${report.estado}`;
            document.getElementById('detailCoords').textContent = `Lat: ${report.latitude} / Lon: ${report.longitude}`;
            document.getElementById('detailVictimSex').textContent = report.sexo;
            document.getElementById('detailVictimAge').textContent = `${report.idade} anos`;
            document.getElementById('detailDescription').textContent = report.descricao;
            
            // Exibe a modal
            detailsModal.classList.remove('hidden');
        };

        // --- 8. LISTENERS GERAIS ---

        document.addEventListener('DOMContentLoaded', () => {
            initDashboard();

            // Listeners para os filtros (recarregam o listener em tempo real)
            filterEstado.addEventListener('change', startRealtimeListener);
            filterMunicipio.addEventListener('change', startRealtimeListener);
            filterBairro.addEventListener('change', startRealtimeListener);

            // Listeners para fechar a modal de detalhes
            const closeModal = () => detailsModal.classList.add('hidden');

            closeDetailsModal.addEventListener('click', closeModal);
            closeDetailsModalBottom.addEventListener('click', closeModal);

            // Fechar modal ao pressionar ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !detailsModal.classList.contains('hidden')) {
                    closeModal();
                }
            });
        });

    </script>

</body>
</html>